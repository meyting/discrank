
{{ block content }}
<!-- The only relevant part is the dragging attribute assigned to the items
  which are supposed to be dragged. -->

<h2>Ranking</h2>
<br />
<p>
    On the left side, you a selection of female workers from our pool of workers, ranked according to their performance
    in the counting task.
    On the right side, you a selection of male workers from our pool of workers, ranked according to their performance
    in the counting task.
    In the middle, you see an empty "Mixed Ranking".
    You can fill this mixed ranking by dragging and dropping a worker from on of the rankings on the sides into the mixed ranking.
</p>
<p><b>Please rank all workers into one mixed ranking.</b></p>

<br />


<div class="container">
  <div class="items-container" id="items-container">
  <div class="headlines"><b>Female Ranking</b></div>
  <div class="row">
    <div class="rank"> 1) </div> <div class="name"><p class="draggable" draggable="true">Lena</p></div>
  </div>
  <div class="row">
    <div class="rank"> 2) </div> <div class="name"><p class="draggable" draggable="true">Lara</p></div>
  </div>
  <div class="row">
    <div class="rank"> 3) </div> <div class="name"><p class="draggable" draggable="true">Clara</p></div>
  </div>
  <div class="row">
    <div class="rank"> 4) </div> <div class="name"><p class="draggable" draggable="true">Sarah</p></div>
  </div>
  <div class="row">
    <div class="rank"> 5) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 6) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 7) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 8) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 9) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 10) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 11) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 12) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 13) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
  <div class="row">
    <div class="rank"> 14) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
  <div class="row">
    <div class="rank"> 15) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
  </div>


  <div class="empty">&nbsp;</div>

  <div class="outcome">
    <div class="headlines"><b>Mixed Ranking</b></div>
  <div class="rank-mixed">
   <div class="row">
     <div class="rank"> 1) </div>
   </div>

   <div class="row">
     <div class="rank"> 2) </div>
   </div>

   <div class="row">
     <div class="rank"> 3) </div>
   </div>

   <div class="row">
     <div class="rank"> 4) </div>
   </div>

   <div class="row">
     <div class="rank"> 5) </div>
   </div>

   <div class="row">
     <div class="rank"> 6) </div>
   </div>

   <div class="row">
     <div class="rank"> 7) </div>
   </div>

   <div class="row">
     <div class="rank"> 8) </div>
   </div>

   <div class="row">
     <div class="rank"> 9) </div>
   </div>

   <div class="row">
     <div class="rank"> 10) </div>
   </div>

   <div class="row">
     <div class="rank"> 11) </div>
   </div>

   <div class="row">
     <div class="rank"> 12) </div>
   </div>

   <div class="row">
     <div class="rank"> 13) </div>
   </div>

   <div class="row">
     <div class="rank"> 14) </div>
   </div>

   <div class="row">
     <div class="rank"> 15) </div>
   </div>

   <div class="row">
     <div class="rank"> 16) </div>
   </div>

   <div class="row">
     <div class="rank"> 17) </div>
   </div>

   <div class="row">
     <div class="rank"> 18) </div>
   </div>

   <div class="row">
     <div class="rank"> 19) </div>
   </div>

   <div class="row">
     <div class="rank"> 20) </div>
   </div>

   <div class="row">
     <div class="rank"> 21) </div>
   </div>

   <div class="row">
     <div class="rank"> 22) </div>
   </div>

   <div class="row">
     <div class="rank"> 23) </div>
   </div>

   <div class="row">
     <div class="rank"> 24) </div>
   </div>

   <div class="row">
     <div class="rank"> 25) </div>
   </div>

   <div class="row">
     <div class="rank"> 26) </div>
   </div>

   <div class="row">
     <div class="rank"> 27) </div>
   </div>

   <div class="row">
     <div class="rank"> 28) </div>
   </div>

   <div class="row">
     <div class="rank"> 29) </div>
   </div>

   <div class="row">
     <div class="rank"> 30) </div>
   </div>
   </div>

   <div class="drop-container">
   </div>


   </div>


  <div class="empty">&nbsp;</div>
  <div class="items-container">
  <div class="headlines"><b>Male Ranking</b></div>
  <div class="row">
    <div class="rank"> 1) </div> <div class="name"><p class="draggable" draggable="true">Florian</p></div>
  </div>
  <div class="row">
    <div class="rank"> 2) </div> <div class="name"><p class="draggable" draggable="true">Markus</p></div>
  </div>
  <div class="row">
    <div class="rank"> 3) </div> <div class="name"><p class="draggable" draggable="true">Jan</p></div>
  </div>
  <div class="row">
    <div class="rank"> 4) </div> <div class="name"><p class="draggable" draggable="true">Simon</p></div>
  </div>
  <div class="row">
    <div class="rank"> 5) </div> <div class="name"><p class="draggable" draggable="true">Florian</p></div>
  </div>
      <div class="row">
    <div class="rank"> 6) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 7) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 8) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 9) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 10) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 11) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 12) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
      <div class="row">
    <div class="rank"> 13) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
  <div class="row">
    <div class="rank"> 14) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
  <div class="row">
    <div class="rank"> 15) </div> <div class="name"><p class="draggable" draggable="true">...</p></div>
  </div>
  </div>

</div>


<div class="footer-container">
<p>Once you have added all items to the mixed ranking, please click on "Next".</p>
    <button class="btn otree-btn-next btn-primary" id="submit-btn">Next</button>

    </div>


    <input type="hidden" name="ranking" id="ranking" />
{{ endblock }}


{{ formfield_errors 'ranking' }}




{{ block app_styles }}
<style>


.container {
    display: flex;
    width: 100%;
    height: 100%;
    font-size: 1.5rem;
    position:relative;
}

.items-container {
    float: left;
    width: 25%;
    background-color: #F5F5F5;
    height: 1110px;
}

.headlines {
    width: 100%;
    text-align: center;
    background-color: #333333;
    border-radius: 5px;
    color: white;
  }

.empty{
    width: 5%;
    float: left;
    }

.row {
    margin-top: 1rem;
    margin-bottom: 1rem;
}

.outcome .row {
    margin-top: 1rem;
    margin-bottom: 1.175rem;
}

.rank {
    width: 15%;
    float: left;
    height: 100%;
    font-weight: bold;
}

.name {
    width: 85%;
    float: left;
    height: 100%;
}

.outcome {
    width: 40%;
    float: left;
    height: 1650px;
    background-color:#F5F5F5;

   }

.rank-mixed {
    text-align: center;
    width: 15%;
    float: left;
    height: 100%;
    background-color:#F5F5F5;
}

.drop-container {
    padding-top: 1rem;
    width: 85%;
    height: 100%;
    float: left;
    background-color:#F5F5F5;
    text-align:center;
}

.draggable {
    border: 1px solid black;
    border-radius: 5px;
    cursor: move;
    text-align: center;
    margin-bottom: 1rem;
    background-color: black;
    color: white;
}

.footer-container {
    margin-top: 10%;
    justify-content: center;
}

.btn {
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: large;
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    cursor: pointer;

}

.dragging {
    opacity: .5;
}



</style>
{{ endblock }}



{{ block app_scripts }}
<script>
"use strict";

let ranking = [];

// This loop adds makes the currently dragged item appear with reduced opacity.
document.querySelectorAll('.draggable').forEach(draggable => {

  draggable.addEventListener('dragstart', () => {
    draggable.classList.add('dragging');
  });

  draggable.addEventListener('dragend', () => {
    draggable.classList.remove('dragging');
  });
});

const dropContainer = document.querySelector('.drop-container');

dropContainer.addEventListener('dragover', (e) => {

  // This is necessary to change the mouse cursor into a symbol
  // which signals that dropping is allowed here.
  e.preventDefault();

  // Only the currently dragged item has the class dragging.
  const draggable = document.querySelector('.dragging');

  // This determines the element which comes after the current mouse position (in the case
  // where there are no such elements, null is returned).
  const afterElement = getDragAfterElement(dropContainer, e.clientY);

  // Place the currently dragged element in the desired position.
  if (afterElement === null) {
    dropContainer.appendChild(draggable);
  } else {
    dropContainer.insertBefore(draggable, afterElement);
  }

  updateranking(dropContainer);
});

function getDragAfterElement(container, y) {
  // Get all elements in the container and place
  // them in an array (so that the reduce function is available).
  const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];

  // Determine the element after the current mouse position.
  return draggableElements.reduce((closest, child) => {

    // This returns information about the position of the currently inspected element.
    const box = child.getBoundingClientRect();

    // (1): box.top - box.height / 2 gives the exact position of the vertical center of
    //      the current element
    // (2): y - "vertical center" < 0 iff the child is below the current mouse position
    const offset = y - box.top - box.height /2

    // This condition only holds when the child is the closest child to the current
    // mouse position.
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element
}

/**
 * Updates the global variable ranking with the currently chosen ranking.
 * @param container
 */
function updateranking(container) {
  ranking = [];
  [...container.children].forEach(child => {
    ranking.push(child.innerText);
  });
}

/**
 * Return true if both item containers are empty.
 *
 * @return {boolean}
 */
function itemsEmpty() {
  return [...document.querySelectorAll('.items-container')]
      .reduce(
          (previousValue, currentContainer) =>
              previousValue && currentContainer.children.length < 17
      , true);
}

document.querySelector('#submit-btn')
    .addEventListener('click', () => {

      // TODO Perform your desired checks (i.e. if all people have been ranked)
      if (! itemsEmpty()) {
        window.alert('Please add all people to your ranking.');
        return;
      }

      // Create an empty invisible form
      const form  = document.createElement('form');
      document.body.appendChild(form);
      form.style.display = 'none';

      // TODO Select appropriate method and action (i.e. target location) here
      form.method = 'POST';
      form.action = '#';

      // Create an array which contains the submitted ranking
      const input = document.createElement('input');
      form.appendChild(input);

      // Add the currently chosen ranking to the input's value
      input.name = 'ranking[]';
      input.value = ranking.reduce((previousValue, currentValue) => {
        return previousValue.concat(currentValue);
      }, []);

      // Submit to Otree form ranking
      document.getElementById('ranking').value = ranking;


      // Submit the form (this uses the method and action from above)
      form.submit();


    });

</script>
{{ endblock }}