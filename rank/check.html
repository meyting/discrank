
{{ block content }}
<!-- The only relevant part is the dragging attribute assigned to the items
  which are supposed to be dragged. -->
<h2>Ranking</h2>
<br />
<p>
    On the left side, you see a random ranking of animals, on the right side, you see a random ranking of vehicles.
    In the middle, you see an empty "Mixed Ranking". You can fill this mixed ranking by dragging and dropping an item
    from on of the rankings on the sides into the mixed ranking. To try this out, please set up the following mixed ranking:
    <br /><br />
    <b>1)</b> <b style="color:red">bike</b>
    <b>2)</b> <b style="color:red">plane</b>
    <b>3)</b> <b style="color:red">cat</b>
    <b>4)</b> <b style="color:red">train</b>
    <b>5)</b> <b style="color:red">dog</b>
    <b>6)</b> <b style="color:red">monkey</b>
    <b>7)</b> <b style="color:red">bird</b>
    <b>8)</b> <b style="color:red">car</b>

</p>

<br />

<div class="container">
  <div class="items-container" id="items-container">
  <div class="headlines"><b>Animals</b></div>
  <div class="row">
    <div class="rank"> 1) </div> <div class="name"><p class="draggable" draggable="true">dog</p></div>
  </div>
  <div class="row">
    <div class="rank"> 2) </div> <div class="name"><p class="draggable" draggable="true">bird</p></div>
  </div>
  <div class="row">
    <div class="rank"> 3) </div> <div class="name"><p class="draggable" draggable="true">cat</p></div>
  </div>
  <div class="row">
    <div class="rank"> 4) </div> <div class="name"><p class="draggable" draggable="true">monkey</p></div>
  </div>

  </div>


  <div class="empty">&nbsp;</div>

  <div class="outcome">
    <div class="headlines"><b>Mixed Ranking</b></div>
  <div class="rank-mixed">
   <div class="row">
     <div class="rank"> 1) </div>
   </div>

   <div class="row">
     <div class="rank"> 2) </div>
   </div>

   <div class="row">
     <div class="rank"> 3) </div>
   </div>

   <div class="row">
     <div class="rank"> 4) </div>
   </div>

   <div class="row">
     <div class="rank"> 5) </div>
   </div>

   <div class="row">
     <div class="rank"> 6) </div>
   </div>

   <div class="row">
     <div class="rank"> 7) </div>
   </div>

   <div class="row">
     <div class="rank"> 8) </div>
   </div>

   </div>

   <div class="drop-container">
   </div>



   </div>


  <div class="empty">&nbsp;</div>
  <div class="items-container">
  <div class="headlines"><b>Vehicles</b></div>
  <div class="row">
    <div class="rank"> 1) </div> <div class="name"><p class="draggable" draggable="true">train</p></div>
  </div>
  <div class="row">
    <div class="rank"> 2) </div> <div class="name"><p class="draggable" draggable="true">car</p></div>
  </div>
  <div class="row">
    <div class="rank"> 3) </div> <div class="name"><p class="draggable" draggable="true">bike</p></div>
  </div>
  <div class="row">
    <div class="rank"> 4) </div> <div class="name"><p class="draggable" draggable="true">plane</p></div>
  </div>

  </div>

</div>

<div class="footer-container">
<p>Once you have added all items to the Mixed Ranking, please click on "Next" to start with the actual task.</p>
    <button class="btn otree-btn-next btn-primary" id="submit-btn">Next</button>

    </div>


    <input type="hidden" name="check" id="ranking" />
{{ endblock }}

{{ formfield_errors 'check' }}




{{ block app_styles }}
<style>

.container {
    display: flex;
    width: 100%;
    height: 100%;
    font-size: 1.5rem;
    position:relative;
}

.items-container {
    float: left;
    width: 25%;
    background-color: #F5F5F5;
    height: 330px;
}

.headlines {
    width: 100%;
    text-align: center;
    background-color: #333333;
    border-radius: 5px;
    color: white;
  }

.empty{
    width: 5%;
    float: left;
    }

.row {
    margin-top: 1rem;
    margin-bottom: 1rem;
}

.outcome .row {
    margin-top: 1rem;
    margin-bottom: 1.112rem;
}

.rank {
    width: 15%;
    float: left;
    height: 100%;
    font-weight: bold;
}

.name {
    width: 85%;
    float: left;
    height: 100%;
}

.outcome {
    width: 40%;
    float: left;
    height: 450px;
    background-color:#F5F5F5;

   }

.rank-mixed {
    text-align: center;
    width: 15%;
    float: left;
    height: 100%;
    background-color:#F5F5F5;
}

.drop-container {
    padding-top: 1rem;
    width: 85%;
    height: 100%;
    float: left;
    background-color:#F5F5F5;
    text-align:center;
}

.draggable {
    border: 1px solid black;
    border-radius: 5px;
    cursor: move;
    text-align: center;
    margin-bottom: 1rem;
    background-color: black;
    color: white;
}

.footer-container {
    margin-top: 10%;
    justify-content: center;
}

.btn {
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    font-size: large;
    background-color: #0d6efd;
    border-color: #0d6efd;
    color: white;
    cursor: pointer;

}

.dragging {
    opacity: .5;
}




</style>
{{ endblock }}


{{ block app_scripts }}
<script>
"use strict";

let ranking = [];

// This loop adds makes the currently dragged item appear with reduced opacity.
document.querySelectorAll('.draggable').forEach(draggable => {

  draggable.addEventListener('dragstart', () => {
    draggable.classList.add('dragging');
  });

  draggable.addEventListener('dragend', () => {
    draggable.classList.remove('dragging');
  });
});

const dropContainer = document.querySelector('.drop-container');

dropContainer.addEventListener('dragover', (e) => {

  // This is necessary to change the mouse cursor into a symbol
  // which signals that dropping is allowed here.
  e.preventDefault();

  // Only the currently dragged item has the class dragging.
  const draggable = document.querySelector('.dragging');

  // This determines the element which comes after the current mouse position (in the case
  // where there are no such elements, null is returned).
  const afterElement = getDragAfterElement(dropContainer, e.clientY);

  // Place the currently dragged element in the desired position.
  if (afterElement === null) {
    dropContainer.appendChild(draggable);
  } else {
    dropContainer.insertBefore(draggable, afterElement);
  }

  updateranking(dropContainer);
});

function getDragAfterElement(container, y) {
  // Get all elements in the container and place
  // them in an array (so that the reduce function is available).
  const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
  // Determine the element after the current mouse position.
  return draggableElements.reduce((closest, child) => {
    // This returns information about the position of the currently inspected element.
    const box = child.getBoundingClientRect();
    // (1): box.top - box.height / 2 gives the exact position of the vertical center of
    //      the current element
    // (2): y - "vertical center" < 0 iff the child is below the current mouse position
    const offset = y - box.top - box.height /2

    // This condition only holds when the child is the closest child to the current
    // mouse position.
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element
}

/**
 * Updates the global variable ranking with the currently chosen ranking.
 * @param container
 */
function updateranking(container) {
  ranking = [];
  [...container.children].forEach(child => {
    ranking.push(child.innerText);
  });
}

/**
 * Return true if both item containers are empty.
 *
 * @return {boolean}
 */


document.querySelector('#submit-btn')
    .addEventListener('click', () => {

      // Create an empty invisible form
      const form  = document.createElement('form');
      document.body.appendChild(form);
      form.style.display = 'none';

      // TODO Select appropriate method and action (i.e. target location) here
      form.method = 'POST';
      form.action = '#';

      // Create an array which contains the submitted ranking
      const input = document.createElement('input');
      form.appendChild(input);


      // Add the currently chosen ranking to the input's value
      input.name = 'ranking[]';
      input.value = ranking.reduce((previousValue, currentValue) => {
        return previousValue.concat(currentValue);
      }, []);

      // Submit to Otree field check
      document.getElementById('ranking').value = ranking;


      // Submit the form (this uses the method and action from above)
      form.submit();
    });



</script>
{{ endblock }}
