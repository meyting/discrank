{{ block title }}
Training
{{ endblock }}

{{ block content }}
<!-- The only relevant part is the dragging attribute assigned to the items
  which are supposed to be dragged. -->
<br />
<p>
    On the left and right side, you see random rankings of the letters.
    In the middle, you see an empty "Mixed Ranking". You can fill this mixed ranking by dragging and dropping an item
    from on of the rankings on the sides into the mixed ranking. To try this out, please set up the following mixed ranking:
    <br /><br />
    <b>1)</b> <b style="color:red">A</b> <br>
    <b>2)</b> <b style="color:red">B</b> <br>
    <b>3)</b> <b style="color:red">C</b> <br>
    <b>4)</b> <b style="color:red">D</b> <br>
    <b>5)</b> <b style="color:red">E</b> <br>
    <b>6)</b> <b style="color:red">F</b> <br>
    <b>7)</b> <b style="color:red">G</b> <br>
    <b>8)</b> <b style="color:red">H</b>

</p>

<br />

<div class="container">

  <div class="row">

    <div class="col-4">
      <h5 class="bg-dark text-white p-2 text-center fw-bold rounded-3 mb-4">Left</h5>
      <div class="row px-4 mb-3">
        <div class="col-2" id="left-container-ranks"></div>
        <div class="col-10">
          <div id="left-container" class="h-100">
          </div>
        </div>
      </div>
    </div>

    <div class="col-4 bg-light rounded-3 px-0">
      <h5 class="bg-dark text-white p-2 text-center fw-bold rounded-3 mb-4">Mixed Ranking</h5>
      <div class="row px-4 mb-3">
        <div class="col-2" id="drop-container-ranks"></div>
        <div class="col-10">
          <div id="drop-container" class="h-100"></div>
        </div>
      </div>
    </div>

    <div class="col-4">
      <h5 class="bg-dark text-white p-2 text-center fw-bold rounded-3 mb-4">Right</h5>
      <div class="row px-4 mb-3">
        <div class="col-2" id="right-container-ranks"></div>
        <div class="col-10">
          <div id="right-container" class="h-100"></div>
        </div>
      </div>
    </div>
  </div>
</div>


  <div class="container mt-5">
    <div class="row">
      <p>Once you have added all items to the mixed ranking, please click on "Next" to start with the actual ranking.</p>
    </div>
    <div class="row">
      <div class="col-4">
        <button class="btn btn-secondary px-5" id="reset-btn" type="button">Reset</button>
      </div>
      <div class="col-4 text-center">
        <button class="btn otree-btn-next btn-primary px-5" id="submit-btn">Next</button>
      </div>
      <div class="col-4"></div>
    </div>
  </div>
<br/>
<br/>
{% include "rank/instructionsonpage.html" %}



    <input type="hidden" name="check" id="check" />
    <input type="hidden" name="abcdleft" id="abcdleft" />
{{ endblock }}


{{ formfield_errors 'check' }}
{{ formfield_errors 'abcdleft' }}




{{ block app_styles }}
<style>


.draggable {
    cursor: move;
    text-align: center;
    background-color: black;
    color: white;
}


.dragging {
    opacity: .5;
}


.bg-success {
    border-color: green;
    }

</style>
{{ endblock }}



{{ block app_scripts }}
<script>
'use strict';

/////////////////////////////////////////////////////////////////////////////////////
// Initial names and correct ranking
/////////////////////////////////////////////////////////////////////////////////////

const FEMALE = ['A', 'B', 'E', 'H'];
const MALE = ['C', 'D', 'F', 'G'];
const MALES_ARE_LEFT_PROB = .5;

// Leave empty (i.e. []) if there is no correct answer (or green highlighting is not desired)
const CORRECT_RANKING = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
const CORRECT_RANKING_EXPLANATION = "Lorem ipsum dolor sit amet, consectetur adipisicing elit. Aperiam architecto " +
    "assumenda, dicta distinctio ea eius enim est impedit inventore magnam minus necessitatibus odio officia " +
    "perspiciatis quae quo reiciendis sunt voluptas!";




/////////////////////////////////////////////////////////////////////////////////////
// DOM Elements
/////////////////////////////////////////////////////////////////////////////////////

const dropContainer = document.querySelector('#drop-container');
const leftContainercheck = document.querySelector('#left-container');
const rightContainercheck = document.querySelector('#right-container');

/////////////////////////////////////////////////////////////////////////////////////
// Local Storage Helpers
/////////////////////////////////////////////////////////////////////////////////////

function getFromLocalStorage(key, defaultValue) {
  const value = sessionStorage.getItem(key);
  if (!value) {
    storeInLocalStorage(key, defaultValue);
    return defaultValue;
  }
  return JSON.parse(value);
}

function storeInLocalStorage(key, value) {
  sessionStorage.setItem(key, JSON.stringify(value));
}

/////////////////////////////////////////////////////////////////////////////////////
// Class Names
/////////////////////////////////////////////////////////////////////////////////////

function Names() {

  this.malesAreLeft = getFromLocalStorage('malesAreLeft', Math.random() < MALES_ARE_LEFT_PROB);

  this.leftNames = this.malesAreLeft ? MALE : FEMALE;
  this.rightNames = this.malesAreLeft ? FEMALE : MALE;
  this.mixedNames = getFromLocalStorage('mixedcheck', []);
}

Names.prototype.update = function () {
  const currentMixedNames = [...dropContainer.querySelectorAll('.draggable')]
      .map(draggable => draggable.innerText);
  storeInLocalStorage('mixedcheck', currentMixedNames);
}

Names.prototype.getMixedNames = function () {
  return getFromLocalStorage('mixedcheck', []);
}

/////////////////////////////////////////////////////////////////////////////////////
// Container Initialization
/////////////////////////////////////////////////////////////////////////////////////

const names = new Names();

function addNamesToContainer(nameArr, container) {
  nameArr.forEach(name => {

    // Create container for the name and a background element
    const outerDiv = document.createElement('div');
    outerDiv.classList.add('position-relative');
    outerDiv.style.height = "2rem";

    // Add a background element which is only visible when the actual element has
    // been dragged to the center. The background element is non-draggable and
    // shows which element was originally placed there.
    const backgroundDiv = document.createElement('div');
    backgroundDiv.classList.add('position-absolute', 'text-center', 'rounded-3', 'w-100');
    backgroundDiv.style.backgroundColor = '#dadada';
    backgroundDiv.style.zIndex = '-1';
    backgroundDiv.innerText = name;

    outerDiv.appendChild(backgroundDiv);

    // Add the actual draggable div in the case where it has not yet been moved
    // to the drop container.
    if (!names.getMixedNames().includes(name)) {
      const div = document.createElement('div');
      div.classList.add('draggable', 'bg-dark', 'text-white', 'rounded-3', 'text-center');
      div.draggable = true;
      div.innerText = name;

      div.addEventListener('dragstart', () => div.classList.add('dragging'));
      div.addEventListener('dragend', () => div.classList.remove('dragging'));

      outerDiv.appendChild(div);
    }

    container.appendChild(outerDiv);

  })
}

function addNamesToDropContainer(nameArr, container) {
  nameArr.forEach(name => {
    const div = document.createElement('div');
    div.classList.add('draggable', 'bg-dark', 'text-white', 'rounded-3', 'text-center', 'mb-2');
    div.draggable = true;
    div.innerText = name;

    div.addEventListener('dragstart', () => div.classList.add('dragging'));
    div.addEventListener('dragend', () => div.classList.remove('dragging'));

    container.appendChild(div);
  })
}

function addRanksToContainer(arr, container) {
  arr.forEach((_, idx) => {
    const div = document.createElement('div');
    div.style.height = "2rem";
    div.innerText = (idx + 1).toString() + ')';
    container.appendChild(div);
  });
}


function displayCorrectRanking() {
  const outerDiv = document.createElement('div');
  outerDiv.classList.add('mb-3');

  const p = document.createElement('p');
  p.innerText = CORRECT_RANKING_EXPLANATION;
  outerDiv.appendChild(p);

  CORRECT_RANKING.forEach((rank, idx) => {
    const div = document.createElement('div');
    div.innerText = (idx + 1).toString() + ') ' + rank;
    outerDiv.appendChild(div);
  })

  document.querySelector('.container').insertBefore(outerDiv, document.querySelector('h1').nextSibling);
}

function isRankingCorrect() {
  dropContainer.querySelectorAll('.draggable')
      .forEach((draggable, idx) => {
        if (CORRECT_RANKING.indexOf(draggable.innerText) === idx) {
          draggable.classList.remove('bg-dark');
          draggable.classList.add('bg-success');
        } else {
          draggable.classList.add('bg-dark');
          draggable.classList.remove('bg-success');
        }
      });
}

function initializeContainers() {
  addNamesToContainer(names.leftNames, leftContainercheck);
  const leftContainercheckRanks = document.querySelector('#left-container-ranks');
  addRanksToContainer(names.leftNames, leftContainercheckRanks);

  addNamesToContainer(names.rightNames, rightContainercheck);
  const rightContainercheckRanks = document.querySelector('#right-container-ranks');
  addRanksToContainer(names.rightNames, rightContainercheckRanks);

  addNamesToDropContainer(names.mixedNames, dropContainer);
  const dropContainerRanks = document.querySelector('#drop-container-ranks');
  addRanksToContainer(
      names.leftNames.concat(names.rightNames)
          .filter(name => !names.mixedNames.includes(name))
          .concat(names.mixedNames),
      dropContainerRanks
  );
}

initializeContainers();

if (CORRECT_RANKING.length > 0) {
  isRankingCorrect();
 // displayCorrectRanking();
}

/////////////////////////////////////////////////////////////////////////////////////
// Dragover Event Handling
/////////////////////////////////////////////////////////////////////////////////////

dropContainer.addEventListener('dragover', (e) => {

  // This is necessary to change the mouse cursor into a symbol
  // which signals that dropping is allowed here.
  e.preventDefault();

  // Only the currently dragged item has the class dragging.
  const draggable = document.querySelector('.dragging');
  draggable.classList.add('mb-2');

  // This determines the element which comes after the current mouse position (in the case
  // where there are no such elements, null is returned).
  const afterElement = getDragAfterElement(dropContainer, e.clientY);

  // Place the currently dragged element in the desired position.
  if (afterElement === null) {
    dropContainer.appendChild(draggable);
  } else {
    dropContainer.insertBefore(draggable, afterElement);
  }

  names.update();

  isRankingCorrect();

});

function getDragAfterElement(container, y) {
  // Get all elements in the container and place
  // them in an array (so that the reduce function is available).
  const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];

  // Determine the element after the current mouse position.
  return draggableElements.reduce((closest, child) => {

    // This returns information about the position of the currently inspected element.
    const box = child.getBoundingClientRect();

    // (1): box.top - box.height / 2 gives the exact position of the vertical center of
    //      the current element
    // (2): y - "vertical center" < 0 iff the child is below the current mouse position
    const offset = y - box.top - box.height / 2

    // This condition only holds when the child is the closest child to the current
    // mouse position.
    if (offset < 0 && offset > closest.offset) {
      return {offset: offset, element: child};
    } else {
      return closest;
    }
  }, {offset: Number.NEGATIVE_INFINITY}).element
}

/////////////////////////////////////////////////////////////////////////////////////
// Submit Functionality
/////////////////////////////////////////////////////////////////////////////////////

document.querySelector('#submit-btn')
    .addEventListener('click', () => {

      // Create an empty invisible form
      const form = document.createElement('form');
      document.body.appendChild(form);
      form.style.display = 'none';

      // Select appropriate method and action (i.e. target location) here
      form.method = 'POST';
      form.action = '#';

      // Add the currently chosen ranking to the input's value
      //const rankingInput = document.createElement('input');
      //form.appendChild(rankingInput);
      //rankingInput.name = 'ranking[]';
      //rankingInput.value = names.getMixedNames();


      // Provide some information whether male names were in the left-hand side container
      //const malesAreLeftInput = document.createElement('input');
      //form.appendChild(malesAreLeftInput);
      //malesAreLeftInput.name = 'males_are_left';
      //malesAreLeftInput.value = names.malesAreLeft;

      console.log(names.getMixedNames())
      console.log(names.malesAreLeft)

      // Submit to Otree form ranking
      document.getElementById('check').value = names.getMixedNames();
      document.getElementById('abcdleft').value = names.malesAreLeft;

      // Submit the form (this uses the method and action from above)
      form.submit();
    });


/////////////////////////////////////////////////////////////////////////////////////
// Reset Button
/////////////////////////////////////////////////////////////////////////////////////

document.getElementById('reset-btn')
    .addEventListener('click', () => {
      window.sessionStorage.clear();
      window.location.reload();
    });


// ----------------------------------------------------------
// endregion Submit Functionality
// ----------------------------------------------------------

</script>
{{ endblock }}
